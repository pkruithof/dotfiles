#!/usr/bin/env bash

set -e

cd "${DOTFILES_ROOT}"

source ${DOTFILES_ROOT}/lib/run
source ${DOTFILES_ROOT}/macos/lib/brew
source ${DOTFILES_ROOT}/macos/lib/php

brew_ensure
gem_ensure
gem_install
php_ensure
php_ensure_apps

# install system default settings
${DOTFILES_ROOT}/macos/bin/defaults

# install vagrant sudoers file
sudoers_file=/private/etc/sudoers.d/vagrant
teebin=$(which tee)
contents=$(sed -E "s|__tee__|$teebin|g" ${DOTFILES_ROOT}/macos/res/vagrant_sudoers)

if [[ ! -f $sudoers_file || $(sudo cat ${sudoers_file}) != "$contents" ]]; then
  e_info "==> installing sudoers file for vagrant"
  echo "${contents}" | (sudo sh -c 'VISUAL="tee" visudo -f /private/etc/sudoers.d/vagrant')
fi
